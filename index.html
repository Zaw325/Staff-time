<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Staff Time Card</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- React & Babel -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<!-- PWA Manifest Link -->
<meta name="theme-color" content="#7c3aed">
<link rel="manifest" href="manifest.json">

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    brand: '#7c3aed', // Violet
                    brandDark: '#5b21b6',
                    brandLight: '#ddd6fe',
                }
            }
        }
    }
</script>

<style>
    body { font-family: sans-serif; background-color: #f3f4f6; }
    .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .animate-pulse-slow { animation: pulse 3s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
</style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect } = React;

    // --- 1. FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyDyuCbPWKCcWYqPCcxW92wE2nZFUu_hC-c",
      authDomain: "mrs-sparkles-qc-app.firebaseapp.com",
      projectId: "mrs-sparkles-qc-app",
      storageBucket: "mrs-sparkles-qc-app.firebasestorage.app",
      messagingSenderId: "692678390922",
      appId: "1:692678390922:web:7cb5b1275e334f9fb0a973"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- 2. ICONS COMPONENTS (Safe Method) ---
    const Icon = ({ d, className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d={d} />
        </svg>
    );

    const Icons = {
        Clock: (props) => <Icon {...props} d="M12 6v6l4 2 M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0" />, // Clock face
        LogOut: (props) => <Icon {...props} d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9" />, // Log out
        Play: (props) => <Icon {...props} d="M5 3l14 9-14 9V3z" />, // Play button
        Stop: (props) => <Icon {...props} d="M9 9h6v6H9z M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0" />, // Stop circle
        MapPin: (props) => <Icon {...props} d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6" /> // Map pin
    };

    // --- 3. LOGIN COMPONENT ---
    const LoginScreen = () => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);

        const handleLogin = async (e) => {
            e.preventDefault();
            setLoading(true);
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (err) {
                setError("Login failed. Please check credentials.");
                setLoading(false);
            }
        };

        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                <div className="bg-white p-8 rounded-2xl card-shadow w-full max-w-sm">
                    <div className="flex justify-center mb-4 text-brand">
                        <Icons.Clock className="w-12 h-12" />
                    </div>
                    <h2 className="text-2xl font-bold text-center text-gray-800 mb-2">Time Keeper</h2>
                    <p className="text-center text-gray-500 mb-6">Staff Login</p>
                    
                    <form onSubmit={handleLogin} className="space-y-4">
                        <input type="email" placeholder="Email" className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand" value={email} onChange={e=>setEmail(e.target.value)} required />
                        <input type="password" placeholder="Password" className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand" value={password} onChange={e=>setPassword(e.target.value)} required />
                        {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                        <button disabled={loading} className="w-full bg-brand text-white py-3 rounded-lg font-bold hover:bg-brandDark transition">
                            {loading ? 'Signing In...' : 'Sign In'}
                        </button>
                    </form>
                </div>
            </div>
        );
    };

    // --- 4. MAIN APP COMPONENT ---
    const TimeCardApp = ({ user }) => {
        const [activeJob, setActiveJob] = useState(null);
        const [availableJobs, setAvailableJobs] = useState([]);
        const [loading, setLoading] = useState(true);
        const [elapsedTime, setElapsedTime] = useState(0);

        useEffect(() => {
            const loadData = async () => {
                setLoading(true);
                
                // Load jobs list
                const unsubscribeJobs = db.collection('jobs').onSnapshot(snapshot => {
                    const jobsData = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    setAvailableJobs(jobsData);
                });

                // Check if currently clocked in
                const activeLogQuery = await db.collection('time_logs')
                    .where('staffUid', '==', user.uid)
                    .where('status', '==', 'active')
                    .limit(1)
                    .get();

                if (!activeLogQuery.empty) {
                    const logDoc = activeLogQuery.docs[0];
                    setActiveJob({ id: logDoc.id, ...logDoc.data() });
                }

                setLoading(false);
                return () => unsubscribeJobs();
            };
            loadData();
        }, [user]);

        // Timer Logic
        useEffect(() => {
            let interval;
            if (activeJob) {
                interval = setInterval(() => {
                    // Handle both Firestore Timestamp and Date object
                    let startMs;
                    if (activeJob.startTime && typeof activeJob.startTime.toDate === 'function') {
                        startMs = activeJob.startTime.toDate().getTime();
                    } else if (activeJob.startTime instanceof Date) {
                        startMs = activeJob.startTime.getTime();
                    } else {
                        startMs = new Date().getTime(); // Fallback
                    }
                    
                    const now = new Date().getTime();
                    setElapsedTime(Math.floor((now - startMs) / 1000));
                }, 1000);
            } else {
                setElapsedTime(0);
            }
            return () => clearInterval(interval);
        }, [activeJob]);

        const formatTime = (totalSeconds) => {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        };

        const handleClockIn = async (job) => {
            if (activeJob) return alert("You are already clocked in!");
            
            const newLog = {
                staffUid: user.uid,
                staffEmail: user.email,
                jobName: job.name,
                jobAddress: job.address || '',
                startTime: new Date(),
                status: 'active'
            };

            try {
                const docRef = await db.collection('time_logs').add(newLog);
                setActiveJob({ id: docRef.id, ...newLog });
            } catch (e) {
                alert("Error clocking in: " + e.message);
            }
        };

        const handleClockOut = async () => {
            if (!activeJob) return;
            if (!confirm("Finish working?")) return;

            try {
                await db.collection('time_logs').doc(activeJob.id).update({
                    endTime: new Date(),
                    status: 'completed',
                    durationSeconds: elapsedTime
                });
                setActiveJob(null);
                alert("Time recorded successfully!");
            } catch (e) {
                alert("Error clocking out: " + e.message);
            }
        };

        const addNewJob = async () => {
            const name = prompt("Enter House/Client Name:");
            if (!name) return;
            const address = prompt("Enter Address (Optional):");
            await db.collection('jobs').add({ name, address, createdAt: new Date() });
        };

        if (loading) return <div className="min-h-screen flex items-center justify-center text-brand font-bold">Loading...</div>;

        return (
            <div className="max-w-md mx-auto min-h-screen bg-gray-100 pb-20 relative">
                
                <div className="bg-brand text-white p-6 rounded-b-3xl shadow-lg">
                    <div className="flex justify-between items-center">
                        <div>
                            <h1 className="text-xl font-bold">Staff: {user.email.split('@')[0]}</h1>
                            <p className="text-brandLight text-sm">{new Date().toDateString()}</p>
                        </div>
                        <button onClick={() => auth.signOut()} className="bg-brandDark p-2 rounded-full hover:bg-opacity-80">
                            <Icons.LogOut className="w-5 h-5" />
                        </button>
                    </div>
                    
                    {activeJob ? (
                        <div className="bg-white text-gray-800 mt-6 p-6 rounded-2xl shadow-xl text-center animate-pulse-slow border-2 border-green-400">
                            <p className="text-xs font-bold text-green-600 uppercase tracking-widest mb-1">WORKING NOW</p>
                            <h2 className="text-xl font-bold truncate">{activeJob.jobName}</h2>
                            <div className="text-5xl font-mono font-bold my-4 text-gray-700">
                                {formatTime(elapsedTime)}
                            </div>
                            <button onClick={handleClockOut} className="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-md flex items-center justify-center gap-2 transition">
                                <Icons.Stop className="w-6 h-6" />
                                CLOCK OUT
                            </button>
                        </div>
                    ) : (
                        <div className="bg-white/10 mt-6 p-6 rounded-2xl border border-white/20 text-center">
                            <p className="text-brandLight font-medium">Not working currently.</p>
                            <p className="text-white text-sm mt-1">Select a job below to start.</p>
                        </div>
                    )}
                </div>

                <div className="p-4">
                    <div className="flex justify-between items-center mb-4 mt-2">
                        <h3 className="font-bold text-gray-700">Jobs List</h3>
                        <button onClick={addNewJob} className="text-xs text-brand font-bold bg-white px-3 py-1 rounded-full shadow-sm border border-gray-200">+ Add Job</button>
                    </div>

                    <div className="space-y-3">
                        {availableJobs.length === 0 && (
                            <p className="text-center text-gray-400 py-8">No jobs found.</p>
                        )}
                        
                        {availableJobs.map(job => (
                            <div key={job.id} className={`bg-white p-4 rounded-xl card-shadow flex justify-between items-center ${activeJob ? 'opacity-50 pointer-events-none grayscale' : ''}`}>
                                <div>
                                    <h4 className="font-bold text-gray-800">{job.name}</h4>
                                    <p className="text-xs text-gray-500 flex items-center gap-1 mt-1">
                                        <Icons.MapPin className="w-3 h-3" />
                                        {job.address || "No address"}
                                    </p>
                                </div>
                                <button 
                                    onClick={() => handleClockIn(job)}
                                    className="bg-green-100 text-green-700 hover:bg-green-600 hover:text-white p-3 rounded-full transition-colors shadow-sm"
                                >
                                    <Icons.Play className="w-6 h-6 fill-current" />
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );
    };

    const Root = () => {
        const [user, setUser] = useState(null);
        const [authChecking, setAuthChecking] = useState(true);

        useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged(u => {
                setUser(u);
                setAuthChecking(false);
            });
            return () => unsubscribe();
        }, []);

        if (authChecking) return null; // Show nothing while checking auth to prevent flicker

        return user ? <TimeCardApp user={user} /> : <LoginScreen />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Root />);
</script>

<!-- PWA Service Worker Register -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW failed', err));
        });
    }
</script>

</body>
</html>


