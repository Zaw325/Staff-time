<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mrs. Sparkle V14 - Ultimate</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<meta name="theme-color" content="#7c3aed">

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    brand: '#7c3aed', 
                    brandDark: '#5b21b6',
                    brandLight: '#ddd6fe',
                    success: '#10b981',
                    warning: '#f59e0b',
                    surface: '#f8fafc',
                },
                animation: {
                    'fade-in': 'fadeIn 0.3s ease-out',
                },
                keyframes: {
                    fadeIn: {
                        '0%': { opacity: '0', transform: 'translateY(10px)' },
                        '100%': { opacity: '1', transform: 'translateY(0)' },
                    }
                }
            }
        }
    }
</script>

<style>
    body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; padding-bottom: env(safe-area-inset-bottom); }
    .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
    .modern-input { width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; background-color: #fff; font-size: 0.95rem; }
    .modern-input:focus { outline: none; border-color: #7c3aed; ring: 2px solid #ddd6fe; }
    
    /* Calendar & Tabs */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; font-size: 0.9rem; position: relative; background: white; border: 1px solid #f1f5f9; }
    .calendar-day.active { background-color: #7c3aed; color: white; border-color: #7c3aed; }
    .calendar-day.has-jobs::after { content: ''; width: 5px; height: 5px; background-color: #10b981; border-radius: 50%; position: absolute; bottom: 6px; }
    .calendar-day.active.has-jobs::after { background-color: white; }
    
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); z-index: 40; }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; font-size: 0.7rem; font-weight: 600; width: 50%; }
    .nav-item.active { color: #7c3aed; }
    
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 50; }
</style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyDyuCbPWKCcWYqPCcxW92wE2nZFUu_hC-c",
      authDomain: "mrs-sparkles-qc-app.firebaseapp.com",
      projectId: "mrs-sparkles-qc-app",
      storageBucket: "mrs-sparkles-qc-app.firebasestorage.app",
      messagingSenderId: "692678390922",
      appId: "1:692678390922:web:7cb5b1275e334f9fb0a973"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- UTILS ---
    const compressImage = (file) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 600; 
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                }
            }
        });
    };

    const getLocalISODate = (date) => {
        const offset = date.getTimezoneOffset();
        const local = new Date(date.getTime() - (offset*60*1000));
        return local.toISOString().split('T')[0];
    };

    // --- ICONS ---
    const Icon = ({ d, className, size = 20 }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d={d} />
        </svg>
    );

    const Icons = {
        Shield: (p) => <Icon {...p} d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
        LogOut: (p) => <Icon {...p} d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9" />,
        Clock: (p) => <Icon {...p} d="M12 6v6l4 2 M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0" />,
        Play: (p) => <Icon {...p} d="M5 3l14 9-14 9V3z" />,
        Stop: (p) => <Icon {...p} d="M9 9h6v6H9z M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0" />,
        MapPin: (p) => <Icon {...p} d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />,
        Calendar: (p) => <Icon {...p} d="M19 21H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2z M16 2v4 M8 2v4 M3 10h18" />,
        ChevronLeft: (p) => <Icon {...p} d="M15 18l-6-6 6-6" />,
        ChevronRight: (p) => <Icon {...p} d="M9 18l6-6-6-6" />,
        Trash: (p) => <Icon {...p} d="M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
        List: (p) => <Icon {...p} d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" />,
        CheckCircle: (p) => <Icon {...p} d="M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4L12 14.01l-3-3" />,
        Camera: (p) => <Icon {...p} d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z M12 13a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />,
        Download: (p) => <Icon {...p} d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3" />,
        Eye: (p) => <Icon {...p} d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z" />,
        Star: (p) => <Icon {...p} d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />,
        Lock: (p) => <Icon {...p} d="M19 11H5a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2zm-7-7a4 4 0 0 0-4 4v3h8V8a4 4 0 0 0-4-4z" />,
        Users: (p) => <Icon {...p} d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M16 3.13a4 4 0 0 1 0 7.75 M23 21v-2a4 4 0 0 0-3-3.87" />,
        Home: (p) => <Icon {...p} d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z M9 22V12h6v10" />,
        Edit: (p) => <Icon {...p} d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />,
        UserPlus: (p) => <Icon {...p} d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M16 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8 M20 8v6 M23 11h-6" />
    };

    // --- LOGIN SCREEN ---
    const LoginScreen = () => {
        const [name, setName] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);

        const handleLogin = async (e) => {
            e.preventDefault();
            setLoading(true);
            const cleanName = name.trim().replace(/\s+/g, '').toLowerCase();
            const fakeEmail = `${cleanName}@mrsparkle.com`;
            try {
                await auth.signInWithEmailAndPassword(fakeEmail, password);
            } catch (err) {
                setError("Login Failed. Check Name/Password.");
                setLoading(false);
            }
        };

        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                <div className="bg-white p-8 rounded-2xl card-shadow w-full max-w-sm">
                    <div className="flex justify-center mb-4"><div className="p-4 bg-brandLight rounded-full"><Icons.Shield size={48} className="text-brand" /></div></div>
                    <h2 className="text-2xl font-bold text-center text-gray-800 mb-1">Mrs. Sparkle</h2>
                    <p className="text-center text-gray-500 mb-8 text-sm">Staff Access Portal</p>
                    <form onSubmit={handleLogin} className="space-y-5">
                        <input type="text" placeholder="Name (e.g. Thidar)" className="modern-input font-bold" value={name} onChange={e=>setName(e.target.value)} required />
                        <input type="password" placeholder="Password" className="modern-input" value={password} onChange={e=>setPassword(e.target.value)} required />
                        {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                        <button disabled={loading} className="w-full bg-brand text-white py-3 rounded-lg font-bold">{loading ? '...' : 'Login'}</button>
                    </form>
                </div>
            </div>
        );
    };

    // --- ADMIN DASHBOARD ---
    const AdminDashboard = ({ user }) => {
        const [activeTab, setActiveTab] = useState('dashboard'); // dashboard, scheduler, staff, history
        const [currentDate, setCurrentDate] = useState(new Date());
        const [selectedDate, setSelectedDate] = useState(new Date());
        const [showCalendar, setShowCalendar] = useState(false);
        const [assignments, setAssignments] = useState([]);
        const [staffList, setStaffList] = useState([]); // Staff collection
        const [historyLogs, setHistoryLogs] = useState([]);
        const [editingJob, setEditingJob] = useState(null); // For Edit Modal

        // Form Data
        const [formData, setFormData] = useState({
            staffId: '', jobName: '', jobAddress: '', jobDuration: '', 
            customerPhone: '', customerRequest: '', startTime: '', endTime: ''
        });
        
        const [newStaffName, setNewStaffName] = useState('');

        useEffect(() => {
            const unsubAssign = db.collection('assignments').onSnapshot(snap => setAssignments(snap.docs.map(d => ({id: d.id, ...d.data()}))));
            const unsubStaff = db.collection('staff').orderBy('name').onSnapshot(snap => setStaffList(snap.docs.map(d => ({id: d.id, ...d.data()}))));
            const unsubHistory = db.collection('time_logs').where('status', '==', 'completed').orderBy('endTime', 'desc').limit(50).onSnapshot(snap => setHistoryLogs(snap.docs.map(d => ({id: d.id, ...d.data()}))));
            return () => { unsubAssign(); unsubStaff(); unsubHistory(); };
        }, []);

        // Helpers
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
        const changeMonth = (offset) => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1));
        const handleDateClick = (d) => { setSelectedDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), d)); setShowCalendar(false); };
        const formatDuration = (seconds) => { if(!seconds) return '0m'; const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60); return h>0 ? `${h}h ${m}m` : `${m}m`; };

        // --- CRUD OPERATIONS ---
        const handleAssign = async () => {
            const { staffId, jobName, startTime } = formData;
            if(!staffId || !jobName || !startTime) return alert("Please select Staff, Job Name and Start Time");
            const targetStaffEmail = `${staffId.trim().replace(/\s+/g, '').toLowerCase()}@mrsparkle.com`;
            
            const jobData = {
                staffEmail: targetStaffEmail, staffId: staffId, 
                jobName: formData.jobName, jobAddress: formData.jobAddress, 
                jobDuration: formData.jobDuration||'Unspecified', 
                customerPhone: formData.customerPhone||'', customerRequest: formData.customerRequest||'', 
                jobDate: getLocalISODate(selectedDate), 
                jobStartTime: formData.startTime, jobEndTime: formData.endTime, 
                assignedBy: user.email, createdAt: new Date(), status: 'pending'
            };

            if (editingJob) {
                await db.collection('assignments').doc(editingJob.id).update(jobData);
                alert("Job Updated!");
                setEditingJob(null);
            } else {
                await db.collection('assignments').add(jobData);
                alert("Job Assigned!");
            }
            setFormData({ staffId: '', jobName: '', jobAddress: '', jobDuration: '', customerPhone: '', customerRequest: '', startTime: '', endTime: '' });
        };

        const startEdit = (job) => {
            setEditingJob(job);
            setFormData({
                staffId: job.staffId, jobName: job.jobName, jobAddress: job.jobAddress, 
                jobDuration: job.jobDuration, customerPhone: job.customerPhone, 
                customerRequest: job.customerRequest, startTime: job.jobStartTime, endTime: job.jobEndTime
            });
            setSelectedDate(new Date(job.jobDate)); // Jump to that date
            window.scrollTo(0,0); // Scroll to form
        };

        const handleDelete = async (id) => { if(confirm("Delete this job permanently?")) await db.collection('assignments').doc(id).delete(); };

        const handleAddStaff = async () => {
            if(!newStaffName) return;
            await db.collection('staff').add({ name: newStaffName, createdAt: new Date() });
            setNewStaffName('');
            alert("Staff added!");
        };

        const handleDeleteStaff = async (id) => { if(confirm("Remove this staff member?")) await db.collection('staff').doc(id).delete(); };

        // Dashboard Stats
        const todayStr = getLocalISODate(new Date());
        const todayJobs = assignments.filter(a => a.jobDate === todayStr);
        const activeJobs = todayJobs.filter(a => a.status === 'active').length;
        const completedJobs = todayJobs.filter(a => a.status === 'completed').length;
        const pendingJobs = todayJobs.length - activeJobs - completedJobs;

        return (
            <div className="max-w-md mx-auto min-h-screen bg-gray-50 pb-24">
                <div className="bg-gray-900 pt-6 px-6 pb-2 rounded-b-3xl shadow-lg mb-6 sticky top-0 z-30">
                    <div className="flex justify-between items-center mb-4 text-white"><h1 className="text-xl font-bold">Manager Portal</h1><button onClick={() => auth.signOut()} className="text-gray-400 text-xs flex items-center gap-1 hover:text-white border border-gray-700 px-2 py-1 rounded"><Icons.LogOut size={12} /> Logout</button></div>
                    <div className="grid grid-cols-4 gap-1 bg-gray-800 p-1 rounded-xl mb-4">
                        {['dashboard','scheduler','staff','history'].map(tab => (
                            <button key={tab} onClick={() => setActiveTab(tab)} className={`py-2 rounded-lg flex flex-col items-center justify-center gap-1 ${activeTab===tab ? 'bg-brand text-white shadow' : 'text-gray-400 hover:bg-gray-700'}`}>
                                {tab==='dashboard' && <Icons.Home size={18} />}
                                {tab==='scheduler' && <Icons.Calendar size={18} />}
                                {tab==='staff' && <Icons.Users size={18} />}
                                {tab==='history' && <Icons.List size={18} />}
                                <span className="text-[9px] uppercase font-bold">{tab}</span>
                            </button>
                        ))}
                    </div>
                </div>

                <div className="px-4 space-y-6">
                    {/* TAB 1: DASHBOARD */}
                    {activeTab === 'dashboard' && (
                        <div className="animate-fade-in space-y-4">
                            <div className="flex justify-between items-end">
                                <h2 className="font-bold text-gray-800 text-lg">Today's Overview</h2>
                                <span className="text-xs font-bold text-brand bg-brandLight px-2 py-1 rounded">{new Date().toDateString()}</span>
                            </div>
                            <div className="grid grid-cols-3 gap-3">
                                <div className="bg-white p-4 rounded-2xl card-shadow text-center"><div className="text-2xl font-bold text-blue-500">{pendingJobs}</div><div className="text-[10px] font-bold text-gray-400 uppercase mt-1">Pending</div></div>
                                <div className="bg-white p-4 rounded-2xl card-shadow text-center"><div className="text-2xl font-bold text-green-500">{activeJobs}</div><div className="text-[10px] font-bold text-gray-400 uppercase mt-1">Active</div></div>
                                <div className="bg-white p-4 rounded-2xl card-shadow text-center"><div className="text-2xl font-bold text-gray-600">{completedJobs}</div><div className="text-[10px] font-bold text-gray-400 uppercase mt-1">Done</div></div>
                            </div>
                            
                            <div className="bg-white p-4 rounded-2xl card-shadow">
                                <h3 className="font-bold text-gray-700 mb-3 text-sm">Live Activity</h3>
                                {todayJobs.length === 0 && <p className="text-gray-400 text-xs italic">No jobs today.</p>}
                                {todayJobs.map(job => (
                                    <div key={job.id} className="flex items-center justify-between py-2 border-b border-gray-50 last:border-0">
                                        <div className="flex items-center gap-2">
                                            <div className={`w-2 h-2 rounded-full ${job.status==='active'?'bg-green-500 animate-pulse':(job.status==='completed'?'bg-gray-300':'bg-blue-500')}`}></div>
                                            <span className="text-sm font-bold text-gray-700">{job.staffId}</span>
                                        </div>
                                        <span className="text-xs text-gray-400">{job.jobName}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* TAB 2: SCHEDULER */}
                    {activeTab === 'scheduler' && (
                        <div className="animate-fade-in">
                             {/* Calendar Widget */}
                            <div className="bg-white p-4 rounded-xl card-shadow mb-4">
                                <div className="flex justify-between items-center mb-4"><button onClick={() => changeMonth(-1)} className="p-1"><Icons.ChevronLeft /></button><h2 className="font-bold text-gray-800">{currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2><button onClick={() => changeMonth(1)} className="p-1"><Icons.ChevronRight /></button></div>
                                <div className="grid grid-cols-7 gap-2 mb-2 text-center text-[10px] font-bold text-gray-400"><div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div></div>
                                <div className="calendar-grid">{Array.from({ length: getFirstDayOfMonth(currentDate.getFullYear(), currentDate.getMonth()) }).map((_, i) => <div key={`e-${i}`} />)}{Array.from({ length: getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth()) }).map((_, i) => { const d = i + 1; const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`; const hasJobs = assignments.some(a => a.jobDate === dateStr); const isSelected = getLocalISODate(selectedDate) === dateStr; return (<div key={d} onClick={() => handleDateClick(d)} className={`calendar-day ${isSelected?'active':''} ${hasJobs?'has-jobs':''}`}>{d}</div>); })}</div>
                            </div>

                            {/* Form */}
                            <div className={`bg-white p-6 rounded-xl card-shadow border-l-4 ${editingJob ? 'border-warning' : 'border-brand'}`}>
                                <h3 className="font-bold text-gray-800 mb-4 text-sm uppercase tracking-wider flex justify-between">
                                    {editingJob ? `Editing Job: ${editingJob.staffId}` : `New Job: ${selectedDate.toDateString()}`}
                                    {editingJob && <button onClick={() => {setEditingJob(null); setFormData({staffId: '', jobName: '', jobAddress: '', jobDuration: '', customerPhone: '', customerRequest: '', startTime: '', endTime: ''})}} className="text-xs text-red-500">Cancel</button>}
                                </h3>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-3 gap-3">
                                        <div className="col-span-2">
                                            <label className="text-xs font-bold text-gray-400 uppercase block mb-1">Staff</label>
                                            <select className="modern-input font-bold" value={formData.staffId} onChange={e=>setFormData({...formData, staffId: e.target.value})}>
                                                <option value="">Select...</option>
                                                {staffList.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                            </select>
                                        </div>
                                        <div className="col-span-1"><label className="text-xs font-bold text-gray-400 uppercase block mb-1">Hrs</label><input type="number" className="modern-input" value={formData.jobDuration} onChange={e=>setFormData({...formData, jobDuration: e.target.value})} /></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3"><div><label className="text-xs font-bold text-gray-400 uppercase block mb-1">Start</label><input type="time" className="modern-input" value={formData.startTime} onChange={e=>setFormData({...formData, startTime: e.target.value})} /></div><div><label className="text-xs font-bold text-gray-400 uppercase block mb-1">End</label><input type="time" className="modern-input" value={formData.endTime} onChange={e=>setFormData({...formData, endTime: e.target.value})} /></div></div>
                                    <input type="text" placeholder="Client / Job Name" className="modern-input" value={formData.jobName} onChange={e=>setFormData({...formData, jobName: e.target.value})} />
                                    <input type="text" placeholder="Address" className="modern-input" value={formData.jobAddress} onChange={e=>setFormData({...formData, jobAddress: e.target.value})} />
                                    <input type="tel" placeholder="Phone" className="modern-input" value={formData.customerPhone} onChange={e=>setFormData({...formData, customerPhone: e.target.value})} />
                                    <textarea placeholder="Notes..." className="modern-input" rows="2" value={formData.customerRequest} onChange={e=>setFormData({...formData, customerRequest: e.target.value})}></textarea>
                                    <button onClick={handleAssign} className={`w-full text-white py-3 rounded-xl font-bold shadow-lg transition ${editingJob ? 'bg-warning hover:bg-orange-600' : 'bg-brand hover:bg-brandDark'}`}>{editingJob ? 'Update Job' : 'Assign Job'}</button>
                                </div>
                            </div>

                            {/* List */}
                            <div className="mt-6">
                                <h3 className="font-bold text-gray-400 text-xs uppercase tracking-wider mb-3 ml-1">Scheduled List</h3>
                                {assignments.filter(a => a.jobDate === getLocalISODate(selectedDate)).map(job => (
                                    <div key={job.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center mb-2">
                                        <div>
                                            <div className="flex items-center gap-2 mb-1"><span className="bg-brandLight text-brandDark text-xs font-bold px-2 py-0.5 rounded capitalize">{job.staffId}</span><span className="font-bold text-gray-800 text-sm">{job.jobName}</span></div>
                                            <p className="text-xs text-gray-500 flex items-center gap-1"><Icons.Clock size={12}/> {job.jobStartTime} - {job.jobEndTime}</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => startEdit(job)} className="text-gray-300 hover:text-blue-500 p-2"><Icons.Edit size={18} /></button>
                                            <button onClick={() => handleDelete(job.id)} className="text-gray-300 hover:text-red-500 p-2"><Icons.Trash size={18} /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* TAB 3: STAFF MANAGEMENT */}
                    {activeTab === 'staff' && (
                        <div className="animate-fade-in">
                            <div className="bg-white p-6 rounded-xl card-shadow mb-6">
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><Icons.UserPlus size={20} className="text-brand"/> Add New Staff</h3>
                                <div className="flex gap-2">
                                    <input type="text" placeholder="Name (e.g. John)" className="modern-input" value={newStaffName} onChange={e=>setNewStaffName(e.target.value)} />
                                    <button onClick={handleAddStaff} className="bg-brand text-white px-6 rounded-lg font-bold shadow-lg">Add</button>
                                </div>
                            </div>
                            <div>
                                <h3 className="font-bold text-gray-400 text-xs uppercase tracking-wider mb-3 ml-1">Staff List ({staffList.length})</h3>
                                {staffList.map(s => (
                                    <div key={s.id} className="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center mb-2">
                                        <span className="font-bold text-gray-700">{s.name}</span>
                                        <button onClick={() => handleDeleteStaff(s.id)} className="text-gray-300 hover:text-red-500"><Icons.Trash size={16} /></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* TAB 4: HISTORY */}
                    {activeTab === 'history' && (
                         <div className="space-y-4 animate-fade-in">
                             {historyLogs.map(log => (
                                <div key={log.id} className="bg-white p-5 rounded-xl card-shadow flex flex-col gap-2">
                                    <div className="flex justify-between items-start">
                                        <div className="flex items-center gap-2"><div className="bg-gray-100 p-2 rounded-full"><Icons.CheckCircle size={20} className="text-green-500" /></div><div><h4 className="font-bold text-gray-800 capitalize">{log.staffId}</h4><p className="text-xs text-gray-500">{log.endTime?log.endTime.toDate().toLocaleDateString():''}</p></div></div>
                                        <div className="text-right"><span className="block font-bold text-brand text-lg">{formatDuration(log.durationSeconds)}</span><span className="text-xs text-gray-400 uppercase font-bold">Worked</span></div>
                                    </div>
                                </div>
                            ))}
                         </div>
                    )}
                </div>
            </div>
        );
    };

    // --- STAFF DASHBOARD ---
    const StaffDashboard = ({ user }) => {
        const [activeTab, setActiveTab] = useState('today'); 
        const [activeJob, setActiveJob] = useState(null);
        const [elapsedTime, setElapsedTime] = useState(0);
        const [myJobs, setMyJobs] = useState([]);
        const [isStopping, setIsStopping] = useState(false);
        const [uploading, setUploading] = useState(false);
        const fileInputRef = useRef(null);
        
        const todayStr = getLocalISODate(new Date());
        
        // Planner State
        const [currentDate, setCurrentDate] = useState(new Date());
        const [selectedDate, setSelectedDate] = useState(new Date());

        useEffect(() => {
            const unsubJobs = db.collection('assignments').where('staffEmail', '==', user.email).onSnapshot(snap => {
                const jobs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                // SORTING LOGIC: Sort by Time
                jobs.sort((a, b) => a.jobStartTime.localeCompare(b.jobStartTime));
                setMyJobs(jobs);
            });
            const checkActive = async () => {
                const activeSnap = await db.collection('time_logs').where('staffUid', '==', user.uid).where('status', '==', 'active').limit(1).get();
                if (!activeSnap.empty) setActiveJob({ id: activeSnap.docs[0].id, ...activeSnap.docs[0].data() });
            };
            checkActive();
            return () => unsubJobs();
        }, [user]);

        useEffect(() => {
            let interval;
            if (activeJob && !isStopping) {
                interval = setInterval(() => {
                    const startMs = activeJob.startTime ? activeJob.startTime.toDate().getTime() : new Date().getTime();
                    setElapsedTime(Math.floor((new Date().getTime() - startMs) / 1000));
                }, 60000);
            }
            return () => clearInterval(interval);
        }, [activeJob, isStopping]);

        const formatDuration = (seconds) => { const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60); return `${h}h ${m}m`; };
        const convertTime12H = (time24) => { if(!time24) return ''; const [h, m] = time24.split(':'); return `${parseInt(h)%12||12}:${m} ${parseInt(h)>=12?'PM':'AM'}`; };

        const handleClockIn = async (newJob) => {
            if (activeJob) return alert("Finish current job first!");
            const displayName = user.email.split('@')[0];
            const logRef = await db.collection('time_logs').add({ staffUid: user.uid, staffId: displayName, jobId: newJob.id, jobName: newJob.jobName, startTime: new Date(), status: 'active' });
            await db.collection('assignments').doc(newJob.id).update({ status: 'active' });
            setActiveJob({ id: logRef.id, jobName: newJob.jobName, jobId: newJob.id, startTime: new Date() });
        };

        const confirmStopWithPhoto = async (e) => {
            const file = e.target.files[0]; if (!file) return; setUploading(true);
            try {
                const compressedBase64 = await compressImage(file);
                const finalDuration = Math.floor((new Date().getTime() - activeJob.startTime.toDate().getTime()) / 1000);
                await db.collection('time_logs').doc(activeJob.id).update({ endTime: new Date(), status: 'completed', durationSeconds: finalDuration, photoBase64: compressedBase64 });
                await db.collection('assignments').doc(activeJob.jobId).update({ status: 'completed' });
                setActiveJob(null); setIsStopping(false); alert("âœ… Job Completed!");
            } catch (err) { alert("Error uploading photo."); }
            setUploading(false);
        };

        const JobCard = ({ job }) => {
            const isActive = activeJob && activeJob.jobId === job.id;
            const isCompleted = job.status === 'completed';
            const isLocked = job.jobDate > todayStr;

            return (
                <div className={`relative bg-white p-4 rounded-2xl card-shadow flex flex-col gap-3 mb-3 transition-all ${isActive?'border-2 border-green-500 ring-4 ring-green-50 z-10':''} ${isCompleted?'disabled-card bg-gray-50':''}`}>
                    <div className="flex justify-between items-start">
                         <div className="flex items-center gap-2 text-sm font-bold text-gray-600 bg-gray-100 px-2 py-1 rounded"><Icons.Clock size={14} />{convertTime12H(job.jobStartTime)}</div>
                         {isLocked && <span className="text-[10px] font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded border border-gray-200 flex items-center gap-1"><Icons.Lock size={10} /> LOCKED</span>}
                    </div>
                    <div className="flex justify-between items-start">
                        <div className="flex-1">
                            <h4 className="font-bold text-gray-800 text-lg">{job.jobName}</h4>
                            {isActive ? (
                                <div className="flex items-center gap-2 mt-1"><span className="text-green-600 font-bold text-sm">ON DUTY</span><span className="bg-green-100 text-green-800 text-xs font-mono px-2 py-1 rounded ml-1">{formatDuration(elapsedTime)}</span></div>
                            ) : (
                                <div className="text-xs text-gray-400 mt-1 font-medium">{job.jobDuration} Hrs</div>
                            )}
                        </div>
                        {!isLocked && (
                            isActive ? (
                                <button onClick={()=>setIsStopping(true)} className="bg-red-500 text-white px-4 py-2 rounded-xl shadow hover:bg-red-600 font-bold text-xs flex items-center gap-1"><Icons.Camera size={16} /> DONE</button>
                            ) : (
                                isCompleted ? <div className="p-2 bg-green-100 rounded-full text-green-600"><Icons.CheckCircle size={24} /></div> :
                                <button onClick={() => handleClockIn(job)} className="p-3 rounded-full shadow-lg bg-brand text-white hover:bg-brandDark"><Icons.Play size={20} fill="currentColor" /></button>
                            )
                        )}
                    </div>
                    <div className={`flex items-start gap-2 text-sm p-3 rounded-xl border ${isLocked ? 'bg-gray-50 border-gray-200 text-gray-400' : 'bg-surface border-gray-100 text-gray-600'}`}>
                        {isLocked ? (
                            <>
                                <Icons.Lock size={16} className="mt-0.5 flex-shrink-0" />
                                <div><span className="font-bold text-xs block uppercase">Location Protected</span><span className="text-xs">Viewable on day of job</span></div>
                            </>
                        ) : (
                            <>
                                <Icons.MapPin size={16} className="mt-0.5 flex-shrink-0 text-gray-400" /><span className="font-medium">{job.jobAddress}</span>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const todayJobs = myJobs.filter(j => j.jobDate === todayStr || j.status === 'active');
        const plannerJobs = myJobs.filter(j => j.jobDate === getLocalISODate(selectedDate));
        // Calculate Hours Today
        const hoursWorkedToday = todayJobs.filter(j => j.status === 'completed').reduce((acc, curr) => acc + (parseFloat(curr.jobDuration) || 0), 0);

        // Calendar Logic
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
        const changeMonth = (offset) => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1));

        return (
            <div className="max-w-md mx-auto min-h-screen bg-gray-50 relative">
                <div className="bg-brand text-white p-6 rounded-b-[2rem] shadow-lg sticky top-0 z-20">
                    <div className="flex justify-between items-center">
                        <div><p className="text-brandLight text-xs uppercase font-bold tracking-wider mb-0.5">Hello,</p><h1 className="text-2xl font-bold capitalize">{user.email.split('@')[0]}</h1></div>
                        <button onClick={() => auth.signOut()} className="bg-white/20 p-2 rounded-full hover:bg-white/30"><Icons.LogOut size={20} /></button>
                    </div>
                </div>

                <div className="px-4 mt-4 pb-24">
                    {activeTab === 'today' && (
                        <div className="animate-fade-in">
                             <div className="flex items-center justify-between mb-4">
                                <div><h3 className="font-bold text-gray-700 text-lg">Today's Tasks</h3><p className="text-xs text-gray-400">Hours Done: <span className="font-bold text-brand">{hoursWorkedToday}h</span></p></div>
                                <span className="text-xs font-bold bg-brandLight text-brand px-2 py-1 rounded">{new Date().toDateString()}</span>
                             </div>
                             {todayJobs.length === 0 ? (
                                <div className="text-center py-12 opacity-50"><Icons.CheckCircle size={48} className="mx-auto mb-2 text-gray-300"/><p className="font-bold text-gray-400">All clear for today!</p></div>
                             ) : (
                                 todayJobs.map(job => <JobCard key={job.id} job={job} />)
                             )}
                        </div>
                    )}
                    {activeTab === 'planner' && (
                        <div className="animate-fade-in">
                            <div className="bg-white p-4 rounded-2xl card-shadow mb-6">
                                <div className="flex justify-between items-center mb-4"><button onClick={() => changeMonth(-1)} className="p-1"><Icons.ChevronLeft /></button><h2 className="font-bold text-gray-800">{currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2><button onClick={() => changeMonth(1)} className="p-1"><Icons.ChevronRight /></button></div>
                                <div className="grid grid-cols-7 gap-1 mb-2 text-center text-[10px] font-bold text-gray-400 uppercase"><div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div></div>
                                <div className="calendar-grid">{Array.from({ length: getFirstDayOfMonth(currentDate.getFullYear(), currentDate.getMonth()) }).map((_, i) => <div key={`e-${i}`} />)}{Array.from({ length: getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth()) }).map((_, i) => { const d = i + 1; const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`; const hasJobs = myJobs.some(a => a.jobDate === dateStr); const isSelected = getLocalISODate(selectedDate) === dateStr; return (<div key={d} onClick={() => setSelectedDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), d))} className={`calendar-day ${isSelected?'active':''} ${hasJobs?'has-jobs':''}`}>{d}</div>); })}</div>
                            </div>
                            <div><h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">Schedule: <span className="text-brand">{selectedDate.toDateString()}</span></h3>{plannerJobs.length === 0 ? (<p className="text-gray-400 text-sm italic bg-white p-4 rounded-xl border border-dashed text-center">No jobs scheduled.</p>) : (plannerJobs.map(job => <JobCard key={job.id} job={job} />))}</div>
                        </div>
                    )}
                </div>

                <div className="bottom-nav">
                    <button onClick={() => setActiveTab('today')} className={`nav-item ${activeTab==='today'?'active':''}`}><Icons.Star size={24} strokeWidth={activeTab==='today'?2.5:2} /><span>TODAY</span></button>
                    <button onClick={() => setActiveTab('planner')} className={`nav-item ${activeTab==='planner'?'active':''}`}><Icons.Calendar size={24} strokeWidth={activeTab==='planner'?2.5:2} /><span>PLANNER</span></button>
                </div>

                {isStopping && (
                    <div className="modal-overlay">
                        <div className="bg-white p-6 rounded-2xl w-full max-w-xs text-center shadow-2xl">
                            <div className="bg-brandLight w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Camera size={32} className="text-brand" /></div>
                            <h3 className="text-xl font-bold text-gray-800 mb-2">Job Complete?</h3>
                            <p className="text-sm text-gray-500 mb-6">Take a photo proof to finish.</p>
                            {uploading ? <div className="py-3 text-brand font-bold animate-pulse">Uploading...</div> : (<div className="space-y-3"><button onClick={()=>fileInputRef.current.click()} className="w-full bg-brand text-white py-3 rounded-xl font-bold shadow-lg">Camera</button><input type="file" accept="image/*" capture="environment" ref={fileInputRef} onChange={confirmStopWithPhoto} className="hidden" /><button onClick={()=>setIsStopping(false)} className="w-full py-3 text-gray-400 font-bold text-sm">Cancel</button></div>)}
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const Root = () => {
        const [user, setUser] = useState(null); const [checking, setChecking] = useState(true);
        useEffect(() => { const sub = auth.onAuthStateChanged(u => { setUser(u); setChecking(false); }); return () => sub(); }, []);
        if(checking) return null; if (!user) return <LoginScreen />;
        if (user.email === 'admin@mrsparkle.com') return <AdminDashboard user={user} />;
        return <StaffDashboard user={user} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Root />);
</script>
</body>
</html>
