<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mrs. Sparkle TimeCard</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- React & Babel -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<!-- PWA Manifest Link -->
<meta name="theme-color" content="#7c3aed">
<link rel="manifest" href="manifest.json">

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    brand: '#7c3aed', // Violet
                    brandDark: '#5b21b6',
                    brandLight: '#ddd6fe',
                    success: '#10b981', // Emerald
                }
            }
        }
    }
</script>

<style>
    body { font-family: sans-serif; background-color: #f3f4f6; }
    .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .status-indicator {
        width: 12px; height: 12px; background-color: #10b981;
        border-radius: 50%; display: inline-block;
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        animation: pulse-green 2s infinite;
    }
    @keyframes pulse-green {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }
</style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect } = React;

    // --- 1. FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyDyuCbPWKCcWYqPCcxW92wE2nZFUu_hC-c",
      authDomain: "mrs-sparkles-qc-app.firebaseapp.com",
      projectId: "mrs-sparkles-qc-app",
      storageBucket: "mrs-sparkles-qc-app.firebasestorage.app",
      messagingSenderId: "692678390922",
      appId: "1:692678390922:web:7cb5b1275e334f9fb0a973"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- 2. SAFE ICONS ---
    const Icon = ({ d, className, size = 24 }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d={d} />
        </svg>
    );

    const Icons = {
        Shield: (p) => <Icon {...p} d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
        LogOut: (p) => <Icon {...p} d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9" />,
        Clock: (p) => <Icon {...p} d="M12 6v6l4 2 M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0" />,
        Play: (p) => <Icon {...p} d="M5 3l14 9-14 9V3z" />,
        Stop: (p) => <Icon {...p} d="M9 9h6v6H9z M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0" />,
        MapPin: (p) => <Icon {...p} d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />,
        Coffee: (p) => <Icon {...p} d="M18 8h1a4 4 0 0 1 0 8h-1 M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z M6 1v3 M10 1v3 M14 1v3" />,
        CalendarPlus: (p) => <Icon {...p} d="M21 12V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h7 M16 2v4 M8 2v4 M3 10h18 M19 16v6 M16 19h6" />,
        Trash: (p) => <Icon {...p} d="M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
    };

    // --- 3. LOGIN SCREEN ---
    const LoginScreen = () => {
        const [staffId, setStaffId] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);

        const handleLogin = async (e) => {
            e.preventDefault();
            setLoading(true);
            const fakeEmail = `${staffId.trim().toLowerCase()}@mrsparkle.com`;
            try {
                await auth.signInWithEmailAndPassword(fakeEmail, password);
            } catch (err) {
                setError("Invalid ID or Password.");
                setLoading(false);
            }
        };

        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                <div className="bg-white p-8 rounded-2xl card-shadow w-full max-w-sm">
                    <div className="flex justify-center mb-4 text-brand">
                        <div className="p-3 bg-brandLight rounded-full">
                            <Icons.Shield size={40} className="text-brand" />
                        </div>
                    </div>
                    <h2 className="text-2xl font-bold text-center text-gray-800 mb-1">Mrs. Sparkle</h2>
                    <p className="text-center text-gray-500 mb-6 text-sm">Staff Access Portal</p>
                    
                    <form onSubmit={handleLogin} className="space-y-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Staff ID</label>
                            <input type="text" placeholder="e.g. S001" className="w-full p-3 border rounded-lg font-bold text-gray-700" value={staffId} onChange={e=>setStaffId(e.target.value)} required />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
                            <input type="password" placeholder="••••••" className="w-full p-3 border rounded-lg" value={password} onChange={e=>setPassword(e.target.value)} required />
                        </div>
                        {error && <p className="text-red-500 text-sm text-center bg-red-50 p-2 rounded">{error}</p>}
                        <button disabled={loading} className="w-full bg-brand text-white py-3 rounded-lg font-bold hover:bg-brandDark transition">
                            {loading ? 'Verifying...' : 'Login'}
                        </button>
                    </form>
                </div>
            </div>
        );
    };

    // --- 4. ADMIN DASHBOARD (NEW: With Job List) ---
    const AdminDashboard = ({ user }) => {
        const [staffId, setStaffId] = useState('');
        const [jobName, setJobName] = useState('');
        const [jobAddress, setJobAddress] = useState('');
        const [recentAssignments, setRecentAssignments] = useState([]);
        
        // Fetch Recent Assignments
        useEffect(() => {
            const unsub = db.collection('assignments')
                .orderBy('createdAt', 'desc')
                .limit(20)
                .onSnapshot(snap => {
                    setRecentAssignments(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });
            return () => unsub();
        }, []);

        const handleAssign = async () => {
            if(!staffId || !jobName) return alert("Please enter Staff ID and Job Name");
            
            const targetStaffEmail = `${staffId.trim().toLowerCase()}@mrsparkle.com`;
            
            await db.collection('assignments').add({
                staffEmail: targetStaffEmail,
                staffId: staffId.toUpperCase(),
                jobName,
                jobAddress,
                assignedBy: user.email,
                createdAt: new Date(),
                status: 'pending'
            });
            
            alert(`Job assigned to ${staffId.toUpperCase()}!`);
            setJobName(''); setJobAddress(''); // Clear form, but keep Staff ID for next entry
        };

        const handleDelete = async (id) => {
            if(confirm("Delete this assignment?")) {
                await db.collection('assignments').doc(id).delete();
            }
        };

        return (
            <div className="max-w-md mx-auto min-h-screen bg-gray-50 pb-20">
                <div className="bg-gray-800 text-white p-6 rounded-b-3xl shadow-lg mb-6">
                    <div className="flex justify-between items-center">
                        <h1 className="text-xl font-bold">Admin Panel</h1>
                        <button onClick={() => auth.signOut()} className="text-gray-300 text-sm flex items-center gap-1">
                            <Icons.LogOut size={16} /> Logout
                        </button>
                    </div>
                </div>

                <div className="p-4 space-y-6">
                    {/* Assignment Form */}
                    <div className="bg-white p-6 rounded-xl card-shadow">
                        <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <Icons.CalendarPlus size={20} /> Assign New Job
                        </h3>
                        
                        <div className="space-y-3">
                            <div>
                                <label className="text-xs font-bold text-gray-500">Assign To (Staff ID)</label>
                                <input type="text" placeholder="e.g. S001" className="w-full p-2 border rounded font-bold text-gray-800" value={staffId} onChange={e=>setStaffId(e.target.value)} />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500">House / Job Name</label>
                                <input type="text" placeholder="e.g. Mrs. Smith Condo" className="w-full p-2 border rounded" value={jobName} onChange={e=>setJobName(e.target.value)} />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500">Address</label>
                                <input type="text" placeholder="Address..." className="w-full p-2 border rounded" value={jobAddress} onChange={e=>setJobAddress(e.target.value)} />
                            </div>
                            <button onClick={handleAssign} className="w-full bg-gray-800 text-white py-3 rounded-lg font-bold hover:bg-gray-900 mt-2">
                                Assign Job
                            </button>
                        </div>
                    </div>

                    {/* Recent Assignments List */}
                    <div>
                        <h3 className="font-bold text-gray-500 text-xs uppercase tracking-wider mb-3 ml-1">Recent Assignments</h3>
                        <div className="space-y-3">
                            {recentAssignments.map(job => (
                                <div key={job.id} className="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center">
                                    <div>
                                        <div className="flex items-center gap-2">
                                            <span className="bg-brandLight text-brandDark text-xs font-bold px-2 py-1 rounded">{job.staffId}</span>
                                            <span className="font-bold text-gray-800">{job.jobName}</span>
                                        </div>
                                        <p className="text-xs text-gray-400 mt-1">
                                            {job.createdAt && job.createdAt.toDate ? job.createdAt.toDate().toLocaleTimeString() : 'Just now'} • {job.status}
                                        </p>
                                    </div>
                                    <button onClick={() => handleDelete(job.id)} className="text-gray-400 hover:text-red-500">
                                        <Icons.Trash size={18} />
                                    </button>
                                </div>
                            ))}
                            {recentAssignments.length === 0 && (
                                <p className="text-center text-gray-400 text-sm py-4">No jobs assigned yet.</p>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    // --- 5. STAFF DASHBOARD (Same as before) ---
    const StaffDashboard = ({ user }) => {
        const [myJobs, setMyJobs] = useState([]);
        const [activeJob, setActiveJob] = useState(null);
        const [elapsedTime, setElapsedTime] = useState(0);

        useEffect(() => {
            const unsubJobs = db.collection('assignments')
                .where('staffEmail', '==', user.email)
                .where('status', 'in', ['pending', 'active'])
                .orderBy('createdAt', 'desc')
                .onSnapshot(snap => {
                    setMyJobs(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });

            const checkActive = async () => {
                const activeSnap = await db.collection('time_logs')
                    .where('staffUid', '==', user.uid)
                    .where('status', '==', 'active')
                    .limit(1)
                    .get();
                if (!activeSnap.empty) {
                    const logData = activeSnap.docs[0].data();
                    setActiveJob({ id: activeSnap.docs[0].id, ...logData });
                }
            };
            checkActive();
            return () => unsubJobs();
        }, [user]);

        useEffect(() => {
            let interval;
            if (activeJob) {
                const updateTimer = () => {
                    let startMs;
                    if (activeJob.startTime && typeof activeJob.startTime.toDate === 'function') {
                        startMs = activeJob.startTime.toDate().getTime();
                    } else if (activeJob.startTime instanceof Date) {
                        startMs = activeJob.startTime.getTime();
                    } else {
                        startMs = new Date().getTime();
                    }
                    const now = new Date().getTime();
                    setElapsedTime(Math.floor((now - startMs) / 1000));
                };
                updateTimer();
                interval = setInterval(updateTimer, 60000);
            }
            return () => clearInterval(interval);
        }, [activeJob]);

        const formatDuration = (seconds) => {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h}h ${m}m`;
        };

        const handleClockIn = async (job) => {
            if (activeJob) return alert("Please finish current job first!");
            
            const logRef = await db.collection('time_logs').add({
                staffUid: user.uid,
                staffId: user.email.split('@')[0].toUpperCase(),
                jobId: job.id,
                jobName: job.jobName,
                startTime: new Date(),
                status: 'active'
            });

            await db.collection('assignments').doc(job.id).update({ status: 'active' });

            setActiveJob({ id: logRef.id, jobName: job.jobName, startTime: new Date() });
        };

        const handleClockOut = async () => {
            if (!confirm("Complete this job?")) return;

            await db.collection('time_logs').doc(activeJob.id).update({
                endTime: new Date(),
                status: 'completed',
                durationSeconds: elapsedTime
            });
            
            setActiveJob(null);
            alert("Job Completed!");
            window.location.reload();
        };

        return (
            <div className="max-w-md mx-auto min-h-screen bg-gray-100 relative">
                <div className="bg-brand text-white p-6 pb-12 rounded-b-3xl shadow-lg">
                    <div className="flex justify-between items-center">
                        <div>
                            <p className="text-brandLight text-xs uppercase font-bold tracking-wider">Welcome</p>
                            <h1 className="text-2xl font-bold">{user.email.split('@')[0].toUpperCase()}</h1>
                        </div>
                        <button onClick={() => auth.signOut()} className="bg-white/20 p-2 rounded-full hover:bg-white/30 transition">
                            <Icons.LogOut size={20} />
                        </button>
                    </div>
                </div>

                <div className="px-4 -mt-8">
                    {activeJob ? (
                        <div className="bg-white rounded-2xl card-shadow p-6 border-l-4 border-green-500 mb-6">
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className="status-indicator"></span>
                                        <span className="text-green-600 font-bold text-sm tracking-wide">ON DUTY</span>
                                    </div>
                                    <h2 className="text-xl font-bold text-gray-800">{activeJob.jobName}</h2>
                                </div>
                                <div className="bg-green-50 text-green-700 px-3 py-1 rounded-lg font-mono font-bold text-xl">
                                    {formatDuration(elapsedTime)}
                                </div>
                            </div>
                            
                            <div className="flex gap-2 text-xs text-gray-400 mb-6">
                                <Icons.Clock size={14} /> Started recently
                            </div>

                            <button onClick={handleClockOut} className="w-full bg-red-500 hover:bg-red-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-red-200 transition flex items-center justify-center gap-2">
                                <Icons.Stop size={20} /> FINISH JOB
                            </button>
                        </div>
                    ) : (
                        <div className="bg-white rounded-2xl card-shadow p-6 mb-6 text-center border border-gray-100">
                            <div className="inline-block p-3 bg-gray-100 rounded-full mb-3 text-gray-400">
                                <Icons.Coffee size={32} />
                            </div>
                            <h3 className="text-gray-800 font-bold">Currently Off Duty</h3>
                            <p className="text-gray-400 text-sm mt-1">Select a job below to clock in.</p>
                        </div>
                    )}

                    <h3 className="font-bold text-gray-500 uppercase text-xs tracking-wider mb-3 ml-1">Your Schedule</h3>
                    <div className="space-y-3 pb-8">
                        {myJobs.map(job => (
                            <div key={job.id} className={`bg-white p-5 rounded-xl card-shadow flex justify-between items-center ${activeJob ? 'opacity-50 grayscale pointer-events-none' : ''}`}>
                                <div>
                                    <h4 className="font-bold text-gray-800 text-lg">{job.jobName}</h4>
                                    {job.jobAddress && (
                                        <p className="text-sm text-gray-500 flex items-center gap-1 mt-1">
                                            <Icons.MapPin size={14} /> {job.jobAddress}
                                        </p>
                                    )}
                                </div>
                                <button onClick={() => handleClockIn(job)} className="bg-brand text-white p-3 rounded-full shadow-lg shadow-violet-200 hover:bg-brandDark transition active:scale-95">
                                    <Icons.Play size={24} fill="currentColor" />
                                </button>
                            </div>
                        ))}
                        {myJobs.length === 0 && (
                            <div className="text-center py-8 text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">
                                No jobs assigned yet.
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    // --- 6. ROOT ---
    const Root = () => {
        const [user, setUser] = useState(null);
        const [checking, setChecking] = useState(true);

        useEffect(() => {
            const sub = auth.onAuthStateChanged(u => {
                setUser(u);
                setChecking(false);
            });
            return () => sub();
        }, []);

        if(checking) return null; 

        if (!user) return <LoginScreen />;

        if (user.email === 'admin@mrsparkle.com') {
            return <AdminDashboard user={user} />;
        }

        return <StaffDashboard user={user} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Root />);
</script>

<!-- PWA Service Worker -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW failed', err));
        });
    }
</script>

</body>
</html>


