<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mrs. Sparkle V10 - Admin Pro</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<meta name="theme-color" content="#1e293b">

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    brand: '#7c3aed', 
                    brandDark: '#5b21b6',
                    brandLight: '#ddd6fe',
                    success: '#10b981',
                    surface: '#f8fafc',
                }
            }
        }
    }
</script>

<style>
    body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
    .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
    .modern-input {
        width: 100%; padding: 0.75rem; border-radius: 0.5rem;
        border: 1px solid #e2e8f0; background-color: #fff;
        transition: all 0.2s; font-size: 0.95rem;
    }
    .modern-input:focus { outline: none; border-color: #7c3aed; ring: 2px solid #ddd6fe; }
    
    /* Calendar Styles */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; font-size: 0.9rem; position: relative; }
    .calendar-day:hover { background-color: #f3f4f6; }
    .calendar-day.active { background-color: #7c3aed; color: white; font-weight: bold; }
    .calendar-day.has-jobs::after { content: ''; width: 6px; height: 6px; background-color: #10b981; border-radius: 50%; position: absolute; bottom: 4px; }
    .calendar-day.active.has-jobs::after { background-color: white; }
    
    /* Tab Styles */
    .tab-btn { padding: 10px; text-align: center; border-radius: 8px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; }
    .tab-btn.active { background-color: white; color: #7c3aed; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .tab-btn.inactive { color: #94a3b8; hover:text-white; }
</style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect } = React;

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyDyuCbPWKCcWYqPCcxW92wE2nZFUu_hC-c",
      authDomain: "mrs-sparkles-qc-app.firebaseapp.com",
      projectId: "mrs-sparkles-qc-app",
      storageBucket: "mrs-sparkles-qc-app.firebasestorage.app",
      messagingSenderId: "692678390922",
      appId: "1:692678390922:web:7cb5b1275e334f9fb0a973"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- ICONS ---
    const Icon = ({ d, className, size = 20 }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d={d} />
        </svg>
    );

    const Icons = {
        Shield: (p) => <Icon {...p} d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
        LogOut: (p) => <Icon {...p} d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9" />,
        Clock: (p) => <Icon {...p} d="M12 6v6l4 2 M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0" />,
        Play: (p) => <Icon {...p} d="M5 3l14 9-14 9V3z" />,
        Stop: (p) => <Icon {...p} d="M9 9h6v6H9z M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0" />,
        MapPin: (p) => <Icon {...p} d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />,
        Phone: (p) => <Icon {...p} d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />,
        Calendar: (p) => <Icon {...p} d="M19 21H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2z M16 2v4 M8 2v4 M3 10h18" />,
        ChevronLeft: (p) => <Icon {...p} d="M15 18l-6-6 6-6" />,
        ChevronRight: (p) => <Icon {...p} d="M9 18l6-6-6-6" />,
        Trash: (p) => <Icon {...p} d="M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
        List: (p) => <Icon {...p} d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" />,
        CheckCircle: (p) => <Icon {...p} d="M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4L12 14.01l-3-3" />
    };

    // --- LOGIN ---
    const LoginScreen = () => {
        const [name, setName] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);

        const handleLogin = async (e) => {
            e.preventDefault();
            setLoading(true);
            const cleanName = name.trim().replace(/\s+/g, '').toLowerCase();
            const fakeEmail = `${cleanName}@mrsparkle.com`;
            try {
                await auth.signInWithEmailAndPassword(fakeEmail, password);
            } catch (err) {
                setError("Login Failed. Check Name/Password.");
                setLoading(false);
            }
        };

        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                <div className="bg-white p-8 rounded-2xl card-shadow w-full max-w-sm">
                    <div className="flex justify-center mb-4">
                        <div className="p-4 bg-brandLight rounded-full"><Icons.Shield size={48} className="text-brand" /></div>
                    </div>
                    <h2 className="text-2xl font-bold text-center text-gray-800 mb-1">Mrs. Sparkle</h2>
                    <p className="text-center text-gray-500 mb-8 text-sm">Staff Access Portal</p>
                    <form onSubmit={handleLogin} className="space-y-5">
                        <input type="text" placeholder="Name (e.g. Thidar)" className="modern-input font-bold" value={name} onChange={e=>setName(e.target.value)} required />
                        <input type="password" placeholder="Password" className="modern-input" value={password} onChange={e=>setPassword(e.target.value)} required />
                        {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                        <button disabled={loading} className="w-full bg-brand text-white py-3 rounded-lg font-bold">{loading ? '...' : 'Login'}</button>
                    </form>
                </div>
            </div>
        );
    };

    // --- ADMIN DASHBOARD ---
    const AdminDashboard = ({ user }) => {
        const [activeTab, setActiveTab] = useState('scheduler'); // 'scheduler' | 'history'
        
        // --- SCHEDULER STATE ---
        const [currentDate, setCurrentDate] = useState(new Date());
        const [selectedDate, setSelectedDate] = useState(new Date());
        const [showCalendar, setShowCalendar] = useState(false); // Toggle Calendar
        const [assignments, setAssignments] = useState([]);
        
        // Form Data
        const [staffId, setStaffId] = useState('');
        const [jobName, setJobName] = useState('');
        const [jobAddress, setJobAddress] = useState('');
        const [jobDuration, setJobDuration] = useState('');
        const [customerPhone, setCustomerPhone] = useState('');
        const [customerRequest, setCustomerRequest] = useState('');
        const [startTime, setStartTime] = useState('');
        const [endTime, setEndTime] = useState('');

        // --- HISTORY STATE ---
        const [historyLogs, setHistoryLogs] = useState([]);

        useEffect(() => {
            // Fetch Assignments
            const unsubAssign = db.collection('assignments').onSnapshot(snap => {
                setAssignments(snap.docs.map(d => ({id: d.id, ...d.data()})));
            });
            // Fetch History (Completed Jobs)
            const unsubHistory = db.collection('time_logs')
                .where('status', '==', 'completed')
                .orderBy('endTime', 'desc')
                .limit(50)
                .onSnapshot(snap => {
                    setHistoryLogs(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });

            return () => { unsubAssign(); unsubHistory(); };
        }, []);

        // --- SCHEDULER HELPERS ---
        const formatDate = (date) => date.toISOString().split('T')[0];
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
        
        const changeMonth = (offset) => {
            setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1));
        };

        const handleDateClick = (d) => {
            setSelectedDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), d));
            setShowCalendar(false); // Auto hide after selection
        };

        const handleAssign = async () => {
            if(!staffId || !jobName || !startTime) return alert("Please fill required fields");
            const targetStaffEmail = `${staffId.trim().replace(/\s+/g, '').toLowerCase()}@mrsparkle.com`;
            const selectedDateStr = formatDate(selectedDate);

            await db.collection('assignments').add({
                staffEmail: targetStaffEmail,
                staffId: staffId,
                jobName, jobAddress, jobDuration: jobDuration || 'Unspecified',
                customerPhone: customerPhone || '', customerRequest: customerRequest || '',
                jobDate: selectedDateStr,
                jobStartTime: startTime, jobEndTime: endTime,
                assignedBy: user.email, createdAt: new Date(), status: 'pending'
            });
            alert(`Job assigned for ${selectedDateStr}!`);
            setJobName(''); setJobAddress(''); setStartTime(''); setEndTime('');
        };

        const handleDelete = async (id) => {
            if(confirm("Delete this assignment?")) await db.collection('assignments').doc(id).delete();
        };
        
        const formatDuration = (seconds) => {
            if(!seconds) return '0m';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            if (h > 0) return `${h}h ${m}m`;
            return `${m} mins`;
        };

        const jobsForSelectedDate = assignments.filter(a => a.jobDate === formatDate(selectedDate));

        return (
            <div className="max-w-md mx-auto min-h-screen bg-gray-50 pb-24">
                {/* HEADER & TABS */}
                <div className="bg-gray-900 pt-6 px-6 pb-4 rounded-b-3xl shadow-lg mb-6 sticky top-0 z-20">
                    <div className="flex justify-between items-center mb-6 text-white">
                        <h1 className="text-xl font-bold">Admin Panel</h1>
                        <button onClick={() => auth.signOut()} className="text-gray-400 text-sm flex items-center gap-1 hover:text-white">
                            <Icons.LogOut size={16} /> Logout
                        </button>
                    </div>
                    {/* TABS */}
                    <div className="flex bg-gray-800 p-1 rounded-xl">
                        <button onClick={() => setActiveTab('scheduler')} className={`flex-1 tab-btn flex items-center justify-center gap-2 ${activeTab==='scheduler' ? 'active' : 'inactive'}`}>
                            <Icons.Calendar size={16} /> Scheduler
                        </button>
                        <button onClick={() => setActiveTab('history')} className={`flex-1 tab-btn flex items-center justify-center gap-2 ${activeTab==='history' ? 'active' : 'inactive'}`}>
                            <Icons.List size={16} /> Staff History
                        </button>
                    </div>
                </div>

                <div className="px-4 space-y-6">
                    
                    {/* === TAB 1: SCHEDULER === */}
                    {activeTab === 'scheduler' && (
                        <>
                            {/* DATE SELECTOR BUTTON */}
                            <div className="flex justify-between items-center bg-white p-4 rounded-xl card-shadow">
                                <div>
                                    <p className="text-xs text-gray-400 uppercase font-bold">Selected Date</p>
                                    <h2 className="text-brand font-bold text-xl">{selectedDate.toDateString()}</h2>
                                </div>
                                <button onClick={() => setShowCalendar(!showCalendar)} className="bg-brandLight text-brand px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2">
                                    <Icons.Calendar size={16} /> {showCalendar ? 'Hide' : 'Select Date'}
                                </button>
                            </div>

                            {/* COLLAPSIBLE CALENDAR */}
                            {showCalendar && (
                                <div className="bg-white p-4 rounded-xl card-shadow animate-fade-in">
                                    <div className="flex justify-between items-center mb-4">
                                        <button onClick={() => changeMonth(-1)} className="p-1"><Icons.ChevronLeft /></button>
                                        <h2 className="font-bold text-gray-800">{currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
                                        <button onClick={() => changeMonth(1)} className="p-1"><Icons.ChevronRight /></button>
                                    </div>
                                    <div className="grid grid-cols-7 gap-4 mb-2 text-center text-xs font-bold text-gray-400">
                                        <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
                                    </div>
                                    <div className="calendar-grid">
                                        {Array.from({ length: getFirstDayOfMonth(currentDate.getFullYear(), currentDate.getMonth()) }).map((_, i) => <div key={`e-${i}`} />)}
                                        {Array.from({ length: getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth()) }).map((_, i) => {
                                            const d = i + 1;
                                            const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                                            const hasJobs = assignments.some(a => a.jobDate === dateStr);
                                            const isSelected = formatDate(selectedDate) === dateStr;
                                            return (
                                                <div key={d} onClick={() => handleDateClick(d)} className={`calendar-day ${isSelected ? 'active' : ''} ${hasJobs ? 'has-jobs' : ''}`}>
                                                    {d}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* JOB ASSIGN FORM */}
                            <div className="bg-white p-6 rounded-xl card-shadow border-l-4 border-brand">
                                <h3 className="font-bold text-gray-800 mb-4 text-sm uppercase tracking-wider">Assign Job</h3>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-3 gap-3">
                                        <div className="col-span-2">
                                            <label className="text-xs font-bold text-gray-400 uppercase block mb-1">Staff Name</label>
                                            <input type="text" placeholder="e.g. Thidar" className="modern-input font-bold" value={staffId} onChange={e=>setStaffId(e.target.value)} />
                                        </div>
                                        <div className="col-span-1">
                                            <label className="text-xs font-bold text-gray-400 uppercase block mb-1">Hrs</label>
                                            <input type="number" placeholder="4" className="modern-input" value={jobDuration} onChange={e=>setJobDuration(e.target.value)} />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-xs font-bold text-gray-400 uppercase block mb-1">Start</label><input type="time" className="modern-input" value={startTime} onChange={e=>setStartTime(e.target.value)} /></div>
                                        <div><label className="text-xs font-bold text-gray-400 uppercase block mb-1">End</label><input type="time" className="modern-input" value={endTime} onChange={e=>setEndTime(e.target.value)} /></div>
                                    </div>
                                    <input type="text" placeholder="Client / Job Name" className="modern-input" value={jobName} onChange={e=>setJobName(e.target.value)} />
                                    <input type="text" placeholder="Address" className="modern-input" value={jobAddress} onChange={e=>setJobAddress(e.target.value)} />
                                    <input type="tel" placeholder="Phone" className="modern-input" value={customerPhone} onChange={e=>setCustomerPhone(e.target.value)} />
                                    <textarea placeholder="Notes..." className="modern-input" rows="2" value={customerRequest} onChange={e=>setCustomerRequest(e.target.value)}></textarea>
                                    <button onClick={handleAssign} className="w-full bg-gray-900 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-black transition">Schedule Job</button>
                                </div>
                            </div>

                            {/* JOB LIST */}
                            <div>
                                <h3 className="font-bold text-gray-400 text-xs uppercase tracking-wider mb-3 ml-1">Scheduled Today</h3>
                                <div className="space-y-3">
                                    {jobsForSelectedDate.length === 0 && <p className="text-sm text-gray-400 italic ml-1">No jobs.</p>}
                                    {jobsForSelectedDate.map(job => (
                                        <div key={job.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                                            <div>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="bg-brandLight text-brandDark text-xs font-bold px-2 py-0.5 rounded capitalize">{job.staffId}</span>
                                                    <span className="font-bold text-gray-800 text-sm">{job.jobName}</span>
                                                </div>
                                                <p className="text-xs text-gray-500 flex items-center gap-1"><Icons.Clock size={12}/> {job.jobStartTime} - {job.jobEndTime}</p>
                                            </div>
                                            <button onClick={() => handleDelete(job.id)} className="text-gray-300 hover:text-red-500 p-2"><Icons.Trash size={18} /></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </>
                    )}

                    {/* === TAB 2: STAFF HISTORY === */}
                    {activeTab === 'history' && (
                        <div className="space-y-4 animate-fade-in">
                            <div className="bg-white p-4 rounded-xl border-l-4 border-green-500 card-shadow">
                                <h3 className="font-bold text-gray-800 text-lg">Work Log Audit</h3>
                                <p className="text-xs text-gray-500">Verify staff locations and durations.</p>
                            </div>

                            {historyLogs.length === 0 ? (
                                <div className="text-center py-10 text-gray-400">No completed jobs yet.</div>
                            ) : (
                                historyLogs.map(log => {
                                    // Parse timestamp for display
                                    const logDate = log.endTime ? log.endTime.toDate().toLocaleDateString() : 'Unknown Date';
                                    const logTime = log.endTime ? log.endTime.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                                    
                                    return (
                                        <div key={log.id} className="bg-white p-5 rounded-xl card-shadow flex flex-col gap-2">
                                            <div className="flex justify-between items-start">
                                                <div className="flex items-center gap-2">
                                                    <div className="bg-gray-100 p-2 rounded-full"><Icons.CheckCircle size={20} className="text-green-500" /></div>
                                                    <div>
                                                        <h4 className="font-bold text-gray-800 capitalize">{log.staffId}</h4>
                                                        <p className="text-xs text-gray-500">{logDate} • Finished at {logTime}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <span className="block font-bold text-brand text-lg">{formatDuration(log.durationSeconds)}</span>
                                                    <span className="text-xs text-gray-400 uppercase font-bold">Worked</span>
                                                </div>
                                            </div>
                                            
                                            <div className="mt-2 pt-3 border-t border-gray-100">
                                                <div className="flex items-start gap-2 text-sm text-gray-600">
                                                    <Icons.MapPin size={16} className="mt-0.5 text-gray-400 shrink-0" />
                                                    <span className="font-medium">{log.jobName}</span>
                                                </div>
                                            </div>
                                        </div>
                                    )
                                })
                            )}
                        </div>
                    )}

                </div>
            </div>
        );
    };

    // --- STAFF DASHBOARD (Keep Existing) ---
    const StaffDashboard = ({ user }) => {
        const [activeJob, setActiveJob] = useState(null);
        const [elapsedTime, setElapsedTime] = useState(0);
        const [myJobs, setMyJobs] = useState([]);

        const getSafeTime = (t) => {
            if (!t) return 0;
            if (t.toDate) return t.toDate().getTime();
            if (t instanceof Date) return t.getTime();
            return 0;
        };

        useEffect(() => {
            const unsubJobs = db.collection('assignments')
                .where('staffEmail', '==', user.email)
                .onSnapshot(snap => {
                    const jobs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    jobs.sort((a, b) => {
                        if (a.jobDate !== b.jobDate) return a.jobDate.localeCompare(b.jobDate);
                        return (a.jobStartTime || '00:00').localeCompare(b.jobStartTime || '00:00');
                    });
                    setMyJobs(jobs);
                });

            const checkActive = async () => {
                const activeSnap = await db.collection('time_logs')
                    .where('staffUid', '==', user.uid)
                    .where('status', '==', 'active')
                    .limit(1)
                    .get();
                if (!activeSnap.empty) {
                    const logData = activeSnap.docs[0].data();
                    setActiveJob({ id: activeSnap.docs[0].id, ...logData });
                }
            };
            checkActive();
            return () => unsubJobs();
        }, [user]);

        useEffect(() => {
            let interval;
            if (activeJob) {
                const updateTimer = () => {
                    const startMs = getSafeTime(activeJob.startTime) || new Date().getTime();
                    const now = new Date().getTime();
                    setElapsedTime(Math.floor((now - startMs) / 1000));
                };
                updateTimer();
                interval = setInterval(updateTimer, 60000);
            }
            return () => clearInterval(interval);
        }, [activeJob]);

        const formatDuration = (seconds) => {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h}h ${m}m`;
        };
        
        const convertTime12H = (time24) => {
            if(!time24) return '';
            const [h, m] = time24.split(':');
            const hour = parseInt(h);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${m} ${ampm}`;
        };

        const stopCurrentJob = async (logId, jobId) => {
            await db.collection('time_logs').doc(logId).update({
                endTime: new Date(),
                status: 'completed',
                durationSeconds: elapsedTime
            });
            if (jobId) await db.collection('assignments').doc(jobId).update({ status: 'completed' });
        };

        const handleClockIn = async (newJob) => {
            if (newJob.status === 'completed') return;
            if (activeJob) {
                if (!confirm(`Switch to "${newJob.jobName}"?`)) return;
                await stopCurrentJob(activeJob.id, activeJob.jobId);
            }
            const displayName = user.email.split('@')[0];
            const logRef = await db.collection('time_logs').add({
                staffUid: user.uid,
                staffId: displayName, 
                jobId: newJob.id,
                jobName: newJob.jobName,
                startTime: new Date(),
                status: 'active'
            });
            await db.collection('assignments').doc(newJob.id).update({ status: 'active' });
            setActiveJob({ id: logRef.id, jobName: newJob.jobName, jobId: newJob.id, startTime: new Date() });
        };

        const handleClockOut = async () => {
            if (!confirm(`Finish job: "${activeJob.jobName}"?`)) return;
            const finalDuration = formatDuration(elapsedTime);
            await stopCurrentJob(activeJob.id, activeJob.jobId);
            setActiveJob(null);
            alert(`✅ JOB COMPLETED!\n\n⏳ Duration: ${finalDuration}`);
        };

        const JobCard = ({ job }) => {
            const isActive = activeJob && activeJob.jobId === job.id;
            const isCompleted = job.status === 'completed';
            const isToday = job.jobDate === new Date().toISOString().split('T')[0];

            return (
                <div className={`relative bg-white p-5 rounded-2xl card-shadow flex flex-col gap-3 mb-4 transition-all ${isActive ? 'border-2 border-green-500 ring-4 ring-green-50 z-10' : ''} ${isCompleted ? 'disabled-card bg-gray-50' : ''}`}>
                    <div className="flex justify-between items-start mb-1">
                        <div className="flex gap-2">
                             <div className={`text-xs font-bold px-2 py-1 rounded border ${isToday ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-gray-100 text-gray-500'}`}>{isToday ? 'TODAY' : job.jobDate}</div>
                            <div className="flex items-center gap-1 text-sm font-bold text-gray-600 bg-gray-100 px-2 py-1 rounded"><Icons.Clock size={14} />{convertTime12H(job.jobStartTime)}</div>
                        </div>
                        {isCompleted && <span className="text-xs font-bold text-white bg-gray-400 px-2 py-1 rounded">DONE</span>}
                    </div>
                    <div className="flex justify-between items-start">
                        <div className="flex-1">
                            <h4 className="font-bold text-gray-800 text-lg leading-tight">{job.jobName}</h4>
                            {isActive ? (
                                <div className="flex items-center gap-2 mt-2"><span className="text-green-600 font-bold text-sm">ON DUTY</span><span className="bg-green-100 text-green-800 text-xs font-mono px-2 py-1 rounded ml-1">{formatDuration(elapsedTime)}</span></div>
                            ) : (
                                <div className="text-xs text-gray-400 mt-1 font-medium">{job.jobDuration} Hrs Estimated</div>
                            )}
                        </div>
                        {isActive ? (
                            <button onClick={handleClockOut} className="bg-red-500 text-white px-4 py-2 rounded-xl shadow-lg hover:bg-red-600 font-bold text-sm"><Icons.Stop size={18} /> STOP</button>
                        ) : (
                            <button onClick={() => handleClockIn(job)} disabled={isCompleted} className={`p-3 rounded-full shadow-lg transition ${isCompleted ? 'bg-gray-200 text-gray-400' : 'bg-brand text-white hover:bg-brandDark'}`}><Icons.Play size={20} fill="currentColor" /></button>
                        )}
                    </div>
                     {job.jobAddress && <div className="flex items-start gap-2 text-sm text-gray-600 bg-surface p-3 rounded-xl border border-gray-100"><Icons.MapPin size={16} className="mt-0.5 flex-shrink-0 text-gray-400" /><span className="font-medium text-gray-700">{job.jobAddress}</span></div>}
                </div>
            );
        };
        const upcomingJobs = myJobs.filter(j => j.status !== 'completed');
        const pastJobs = myJobs.filter(j => j.status === 'completed');
        return (
            <div className="max-w-md mx-auto min-h-screen bg-gray-50 relative">
                <div className="bg-brand text-white p-6 pb-10 rounded-b-[2rem] shadow-xl">
                    <div className="flex justify-between items-center">
                        <div><p className="text-brandLight text-xs uppercase font-bold tracking-wider mb-0.5">Hello,</p><h1 className="text-2xl font-bold capitalize">{user.email.split('@')[0]}</h1></div>
                        <button onClick={() => auth.signOut()} className="bg-white/20 p-2 rounded-full hover:bg-white/30"><Icons.LogOut size={20} /></button>
                    </div>
                </div>
                <div className="px-4 -mt-6 space-y-6 pb-12">
                    <div><h3 className="font-bold text-gray-500 uppercase text-xs tracking-widest mb-3 ml-1">Upcoming</h3>{upcomingJobs.length === 0 && <p className="text-gray-400 text-center py-4 bg-white rounded-xl border border-dashed">No upcoming jobs.</p>}{upcomingJobs.map(job => <JobCard key={job.id} job={job} />)}</div>
                    {pastJobs.length > 0 && (<div className="opacity-60"><h3 className="font-bold text-gray-500 uppercase text-xs tracking-widest mb-3 ml-1">Completed</h3>{pastJobs.map(job => <JobCard key={job.id} job={job} />)}</div>)}
                </div>
            </div>
        );
    };

    const Root = () => {
        const [user, setUser] = useState(null);
        const [checking, setChecking] = useState(true);
        useEffect(() => {
            const sub = auth.onAuthStateChanged(u => { setUser(u); setChecking(false); });
            return () => sub();
        }, []);
        if(checking) return null; 
        if (!user) return <LoginScreen />;
        if (user.email === 'admin@mrsparkle.com') return <AdminDashboard user={user} />;
        return <StaffDashboard user={user} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Root />);
</script>
</body>
</html>
